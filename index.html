<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔮 Complete Soul Age Calculator with All Tabs</title>
    <style>
        :root {
            --primary: #9333EA;
            --secondary: #3B82F6;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --text: #1F2937;
            --text-light: #6B7280;
            --bg: #F8FAFC;
            --surface: #FFFFFF;
            --border: #E5E7EB;
            --shadow: rgba(0, 0, 0, 0.1);
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gradient);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(135deg, #ffffff, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header .subtitle {
            color: #E0E7FF;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .privacy-notice {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        /* Tabs Navigation */
        .tabs-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 10px 25px var(--shadow);
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #6B7280;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover {
            background: #F3F4F6;
        }

        .tab-btn.active {
            background: var(--gradient);
            color: white;
            border-color: transparent;
        }

        .tab-icon {
            font-size: 1.2rem;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Sections */
        .section {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px var(--shadow);
            position: relative;
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
        }

        .section-icon {
            font-size: 2rem;
            margin-right: 15px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
        }

        /* Time Input Container */
        .time-container {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .time-container select,
        .time-container input {
            flex: 1;
            min-width: 60px;
        }

        .unknown-time-btn {
            padding: 10px 16px;
            background: var(--warning);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .unknown-time-btn:hover {
            background: #D97706;
            transform: translateY(-1px);
        }

        /* Location */
        .location-group {
            position: relative;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--border);
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 5px 15px var(--shadow);
        }

        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .autocomplete-item:hover {
            background: #F3F4F6;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .location-name {
            font-weight: 600;
            color: var(--text);
        }

        .location-details {
            display: block;
            font-size: 0.85rem;
            color: #6B7280;
            margin-top: 2px;
        }

        /* Survey Questions */
        .survey-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .question-card {
            background: #F9FAFB;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }

        .question-text {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text);
        }

        .question-card select {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: white;
            cursor: pointer;
        }

        /* Calculate Button */
        .calculate-btn {
            background: var(--gradient);
            color: white;
            padding: 18px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto;
            min-width: 250px;
            box-shadow: 0 10px 25px rgba(147, 51, 234, 0.3);
        }

        .calculate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(147, 51, 234, 0.4);
        }

        .calculate-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }

        .loading.show {
            opacity: 1;
            transform: translateY(0);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #E5E7EB;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Results */
        .results-container {
            display: none;
            margin-top: 30px;
        }

        .results-container.show {
            display: block;
            animation: slideIn 0.8s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .soul-age-display {
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .soul-age-number {
            font-size: 4rem;
            font-weight: 900;
            margin-bottom: 10px;
            text-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .soul-stage {
            font-size: 1.4rem;
            opacity: 0.9;
            margin-bottom: 30px;
        }

        .incarnation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Error Messages */
        .error-message {
            color: var(--danger);
            font-size: 0.9rem;
            margin-top: 5px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .error-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Validation Indicators */
        .validation-indicator {
            margin-left: 8px;
            font-size: 0.9rem;
        }

        .validation-indicator.valid::after {
            content: "✓";
            color: var(--success);
        }

        .validation-indicator.invalid::after {
            content: "✗";
            color: var(--danger);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .tabs-nav {
                flex-direction: column;
                gap: 5px;
            }
            
            .tab-btn {
                justify-content: center;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .time-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .soul-age-number {
                font-size: 3rem;
            }
            
            .incarnation-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Understanding Tab Styles */
        .stage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stage-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid var(--primary);
            transition: transform 0.3s ease;
        }

        .stage-card:hover {
            transform: translateY(-5px);
        }

        .stage-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .stage-description {
            color: var(--text-light);
            line-height: 1.6;
        }

        /* Security Badge */
        .security-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 25px;
            box-shadow: 0 5px 15px var(--shadow);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-light);
            backdrop-filter: blur(10px);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🔮 Complete Soul Age Calculator</h1>
            <p class="subtitle">
                Discover your spiritual evolution through Vedantic wisdom and astrological analysis
            </p>
            <div class="privacy-notice">
                🔒 100% Privacy Guaranteed - No Data Storage - GDPR Compliant
            </div>
        </header>

        <!-- Tabs Navigation -->
        <nav class="tabs-nav">
            <button class="tab-btn active" data-tab="calculate">
                <span class="tab-icon">📊</span>
                Calculate
            </button>
            <button class="tab-btn" data-tab="understanding">
                <span class="tab-icon">📚</span>
                Understanding
            </button>
            <button class="tab-btn" data-tab="guidance">
                <span class="tab-icon">🧘</span>
                Spiritual Guidance
            </button>
        </nav>

        <!-- Tab 1: Calculate -->
        <div id="calculate-tab" class="tab-content active">
            <!-- Birth Information -->
            <div class="section">
                <div class="section-header">
                    <span class="section-icon">⭐</span>
                    <h2 class="section-title">Birth Information</h2>
                </div>
                
                <form id="birthForm" novalidate>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="birthDate">
                                Birth Date
                                <span class="validation-indicator" id="dateValidation"></span>
                            </label>
                            <input type="date" id="birthDate" required>
                            <div class="error-message" id="dateError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="birthTime">
                                Birth Time (Optional - uses noon if unknown)
                                <span class="validation-indicator" id="timeValidation"></span>
                            </label>
                            <div class="time-container">
                                <select id="birthHour">
                                    <option value="">HH</option>
                                    <option value="1">01</option>
                                    <option value="2">02</option>
                                    <option value="3">03</option>
                                    <option value="4">04</option>
                                    <option value="5">05</option>
                                    <option value="6">06</option>
                                    <option value="7">07</option>
                                    <option value="8">08</option>
                                    <option value="9">09</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                </select>
                                <input type="number" id="birthMinute" placeholder="MM" min="0" max="59">
                                <select id="ampm">
                                    <option value="">AM/PM</option>
                                    <option value="AM">AM</option>
                                    <option value="PM">PM</option>
                                </select>
                                <button type="button" class="unknown-time-btn" id="unknownTimeBtn">
                                    Unknown Time
                                </button>
                            </div>
                            <div class="error-message" id="timeError"></div>
                        </div>
                        
                        <div class="form-group location-group">
                            <label for="birthPlace">
                                Birth Location
                                <span class="validation-indicator" id="placeValidation"></span>
                            </label>
                            <input type="text" id="birthPlace" placeholder="Start typing city name..." autocomplete="off">
                            <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
                            <div class="error-message" id="placeError"></div>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Latitude</label>
                            <input type="number" id="latitude" step="0.0001" readonly>
                        </div>
                        <div class="form-group">
                            <label>Longitude</label>
                            <input type="number" id="longitude" step="0.0001" readonly>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Spiritual Assessment -->
            <div class="section">
                <div class="section-header">
                    <span class="section-icon">🧘</span>
                    <h2 class="section-title">Spiritual Experience Assessment</h2>
                </div>
                
                <p style="color: #6B7280; margin-bottom: 20px;">
                    These questions help calibrate your soul age calculation by assessing karmic patterns and spiritual development markers.
                </p>
                
                <div class="survey-grid" id="surveyQuestions">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <button class="calculate-btn" id="calculateBtn">
                ✨ Calculate My Soul Age
            </button>

            <!-- Loading State -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 20px; color: var(--primary);">
                    Analyzing your karmic blueprint through Vedantic algorithms...
                </p>
            </div>

            <!-- Results -->
            <div class="results-container" id="resultsContainer">
                <div class="soul-age-display">
                    <div id="timeEstimatedNotice" style="background: rgba(255,193,7,0.2); color: #856404; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; display: none;">
                        ⚠️ Time estimated as 12:00 PM - results may vary by ±50 incarnations
                    </div>
                    <div class="soul-age-number" id="soulAgeNumber">~432</div>
                    <div class="soul-stage" id="soulStage">Mature Soul - Heart Chakra Activation</div>
                    
                    <div class="incarnation-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="incarnationRange">425-440</div>
                            <div class="stat-label">Incarnation Range</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="earthYears">~71k</div>
                            <div class="stat-label">Earth Years</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="spiralLevel">4th</div>
                            <div class="stat-label">Spiral Level</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="remainingLives">345</div>
                            <div class="stat-label">Lives to Liberation</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Understanding -->
        <div id="understanding-tab" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <span class="section-icon">📚</span>
                    <h2 class="section-title">Understanding Soul Ages</h2>
                </div>

                <p style="line-height: 1.8; color: #4B5563; margin-bottom: 30px;">
                    Soul age represents the number of incarnations a soul has experienced in its journey toward liberation. 
                    This system is based on Vedantic teachings and incorporates Sinnett's 777-incarnation spiral evolution model.
                </p>

                <div class="stage-grid">
                    <div class="stage-card">
                        <div class="stage-title">🌱 Infant Soul (1-35)</div>
                        <div class="stage-description">
                            Beginning their earthly journey, focused on survival, basic needs, and simple lessons. 
                            Often drawn to traditional structures and clear authorities.
                        </div>
                    </div>
                    <div class="stage-card">
                        <div class="stage-title">👶 Baby Soul (36-105)</div>
                        <div class="stage-description">
                            Learning civilization rules, seeking structure and meaning. Strong moral compass, 
                            preference for established systems and traditional values.
                        </div>
                    </div>
                    <div class="stage-card">
                        <div class="stage-title">🧑 Young Soul (106-210)</div>
                        <div class="stage-description">
                            Ambitious and achievement-oriented, focused on success, power, and recognition. 
                            Competitive nature, building civilizations and personal accomplishments.
                        </div>
                    </div>
                    <div class="stage-card">
                        <div class="stage-title">🧘 Mature Soul (211-350)</div>
                        <div class="stage-description">
                            Emotional and relationship-focused, seeking meaning and authentic connection. 
                            High empathy, psychological awareness, and interest in personal growth.
                        </div>
                    </div>
                    <div class="stage-card">
                        <div class="stage-title">👴 Old Soul (351-490)</div>
                        <div class="stage-description">
                            Wise and detached, focused on teaching, spirituality, and service. 
                            Natural philosophers with broad perspective and deep understanding.
                        </div>
                    </div>
                    <div class="stage-card">
                        <div class="stage-title">🎭 7th Level Souls (491-700)</div>
                        <div class="stage-description">
                            Integration phase, mastering all previous lessons while preparing for transcendence. 
                            Often serve as bridges between physical and spiritual realms.
                        </div>
                    </div>
                    <div class="stage-card">
                        <div class="stage-title">🌟 Advanced Souls (701-777)</div>
                        <div class="stage-description">
                            Final incarnations before liberation, serving as spiritual teachers and guides. 
                            Rarely incarnate, only for specific missions of global significance.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Spiritual Guidance -->
        <div id="guidance-tab" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <span class="section-icon">🧘</span>
                    <h2 class="section-title">Personalized Spiritual Guidance</h2>
                </div>

                <div style="background: #F0F9FF; padding: 25px; border-radius: 15px; border-left: 5px solid #0EA5E9; margin-bottom: 30px;">
                    <p style="line-height: 1.8; color: #4B5563;">
                        Based on your soul age calculation, receive personalized guidance for your spiritual journey, 
                        including recommended practices, karmic lessons, and soul mission insights.
                    </p>
                </div>

                <div id="guidanceContent" style="display: none;">
                    <!-- Will be populated after calculation -->
                </div>

                <div style="text-align: center; color: #6B7280; padding: 40px;">
                    Complete your soul age calculation first to receive personalized spiritual guidance.
                </div>
            </div>
        </div>
    </div>

    <!-- Security Badge -->
    <div class="security-badge">
        <span>🔒</span>
        <span>Secure • No Data Storage • GDPR Compliant</span>
    </div>

    <script>
        // State Management - In-memory only, no persistence
        const AppState = {
            currentTab: 'calculate',
            birthData: null,
            surveyAnswers: {},
            calculationResults: null,
            sessionId: generateSessionId(),
            isCalculating: false,
            timeEstimated: false
        };

        // Spiritual Questions
        const spiritualQuestions = [
            {
                text: "How often do you experience synchronicities or meaningful coincidences?",
                options: ["Never", "Rarely", "Sometimes", "Often", "Constantly"],
                weight: 0.15
            },
            {
                text: "How naturally does meditation or contemplation come to you?",
                options: ["Very difficult", "Challenging", "Moderate effort", "Comes easily", "Effortless"],
                weight: 0.12
            },
            {
                text: "How important is personal achievement and recognition to you?",
                options: ["Extremely important", "Very important", "Moderately important", "Somewhat important", "Not important"],
                weight: 0.13
            },
            {
                text: "How strongly do you feel a sense of life purpose or mission?",
                options: ["No sense", "Vague feeling", "Some clarity", "Clear purpose", "Urgent mission"],
                weight: 0.17
            },
            {
                text: "How easily do you detach from material possessions and outcomes?",
                options: ["Very attached", "Somewhat attached", "Balanced", "Easily detached", "Naturally detached"],
                weight: 0.15
            },
            {
                text: "How often do you experience states of expanded consciousness?",
                options: ["Never", "Rarely", "Monthly", "Weekly", "Daily"],
                weight: 0.15
            },
            {
                text: "How much do you feel drawn to teaching or guiding others?",
                options: ["Not at all", "Slightly", "Moderately", "Strongly", "It's my calling"],
                weight: 0.13
            }
        ];

        // Simple cities database for offline functionality
        const cities = [
            {name: "New York", country: "USA", lat: 40.7128, lng: -74.0060},
            {name: "Los Angeles", country: "USA", lat: 34.0522, lng: -118.2437},
            {name: "Chicago", country: "USA", lat: 41.8781, lng: -87.6298},
            {name: "Houston", country: "USA", lat: 29.7604, lng: -95.3698},
            {name: "London", country: "UK", lat: 51.5074, lng: -0.1278},
            {name: "Paris", country: "France", lat: 48.8566, lng: 2.3522},
            {name: "Tokyo", country: "Japan", lat: 35.6762, lng: 139.6503},
            {name: "Sydney", country: "Australia", lat: -33.8688, lng: 151.2093},
            {name: "Mumbai", country: "India", lat: 19.0760, lng: 72.8777},
            {name: "Delhi", country: "India", lat: 28.7041, lng: 77.1025},
            {name: "Toronto", country: "Canada", lat: 43.6532, lng: -79.3832},
            {name: "Berlin", country: "Germany", lat: 52.5200, lng: 13.4050},
            {name: "Madrid", country: "Spain", lat: 40.4168, lng: -3.7038},
            {name: "Rome", country: "Italy", lat: 41.9028, lng: 12.4964},
            {name: "Bangkok", country: "Thailand", lat: 13.7563, lng: 100.5018}
        ];

        // Initialize Application
        function initApp() {
            setupTabs();
            setupForm();
            setupAutocomplete();
            setupUnknownTime();
            initializeSurvey();
            setupValidation();
        }

        // Generate Session ID
        function generateSessionId() {
            const array = new Uint8Array(16);
            crypto.getRandomValues(array);
            return Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
        }

        // Tab Navigation
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.dataset.tab;
                    
                    // Update buttons
                    tabButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Update content
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                    });
                    const targetContent = document.getElementById(`${targetTab}-tab`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                    
                    AppState.currentTab = targetTab;
                });
            });
        }

        // Form Setup
        function setupForm() {
            const calculateBtn = document.getElementById('calculateBtn');
            
            calculateBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (validateForm()) {
                    calculateSoulAge();
                }
            });
        }

        // Setup Unknown Time Button
        function setupUnknownTime() {
            const unknownBtn = document.getElementById('unknownTimeBtn');
            
            unknownBtn.addEventListener('click', () => {
                // Set time to noon (12:00 PM)
                document.getElementById('birthHour').value = '12';
                document.getElementById('birthMinute').value = '0';
                document.getElementById('ampm').value = 'PM';
                
                // Mark as estimated time
                AppState.timeEstimated = true;
                
                // Update validation
                showValidation('timeValidation', true);
                hideError('timeError');
                
                // Visual feedback
                unknownBtn.innerHTML = '✅ Set to Noon';
                unknownBtn.style.background = '#10B981';
                
                setTimeout(() => {
                    unknownBtn.innerHTML = 'Unknown Time';
                    unknownBtn.style.background = '#F59E0B';
                }, 2000);
            });
        }

        // Setup Autocomplete
        function setupAutocomplete() {
            const input = document.getElementById('birthPlace');
            const dropdown = document.getElementById('autocompleteDropdown');
            
            input.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                
                if (query.length < 2) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                const matches = cities.filter(city => 
                    city.name.toLowerCase().includes(query) ||
                    city.country.toLowerCase().includes(query)
                ).slice(0, 10);
                
                if (matches.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                dropdown.innerHTML = matches.map(city => `
                    <div class="autocomplete-item" data-lat="${city.lat}" data-lng="${city.lng}" data-name="${city.name}, ${city.country}">
                        <div class="location-name">${city.name}</div>
                        <span class="location-details">${city.country}</span>
                    </div>
                `).join('');
                
                dropdown.style.display = 'block';
                
                // Add click handlers
                dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const lat = parseFloat(item.dataset.lat);
                        const lng = parseFloat(item.dataset.lng);
                        const name = item.dataset.name;
                        
                        input.value = name;
                        document.getElementById('latitude').value = lat;
                        document.getElementById('longitude').value = lng;
                        
                        dropdown.style.display = 'none';
                        
                        showValidation('placeValidation', true);
                        hideError('placeError');
                    });
                });
            });
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        // Initialize Survey Questions
        function initializeSurvey() {
            const container = document.getElementById('surveyQuestions');
            
            container.innerHTML = spiritualQuestions.map((question, index) => `
                <div class="question-card">
                    <div class="question-text">${question.text}</div>
                    <select id="question-${index}">
                        <option value="">Choose your answer...</option>
                        ${question.options.map((option, optIndex) => 
                            `<option value="${optIndex}">${option}</option>`
                        ).join('')}
                    </select>
                </div>
            `).join('');
            
            // Add change handlers
            spiritualQuestions.forEach((_, index) => {
                document.getElementById(`question-${index}`).addEventListener('change', (e) => {
                    AppState.surveyAnswers[index] = parseInt(e.target.value);
                });
            });
        }

        // Setup Validation
        function setupValidation() {
            const birthDate = document.getElementById('birthDate');
            const birthHour = document.getElementById('birthHour');
            const birthMinute = document.getElementById('birthMinute');
            const ampm = document.getElementById('ampm');
            
            birthDate.addEventListener('blur', () => validateDate());
            [birthHour, birthMinute, ampm].forEach(el => {
                el.addEventListener('change', () => validateTime());
            });
        }

        // Validation Functions
        function validateDate() {
            const input = document.getElementById('birthDate');
            const date = new Date(input.value);
            const now = new Date();
            const minDate = new Date(now.getFullYear() - 150, 0, 1);
            
            if (!input.value) {
                showError('dateError', 'Birth date is required');
                showValidation('dateValidation', false);
                return false;
            }
            
            if (date > now) {
                showError('dateError', 'Birth date cannot be in the future');
                showValidation('dateValidation', false);
                return false;
            }
            
            if (date < minDate) {
                showError('dateError', 'Birth date seems too far in the past');
                showValidation('dateValidation', false);
                return false;
            }
            
            hideError('dateError');
            showValidation('dateValidation', true);
            return true;
        }

        function validateTime() {
            const hour = document.getElementById('birthHour').value;
            const minute = document.getElementById('birthMinute').value;
            const ampm = document.getElementById('ampm').value;
            
            // Time is optional - if all fields are empty, that's okay
            if (!hour && !minute && !ampm) {
                showValidation('timeValidation', true);
                hideError('timeError');
                return true;
            }
            
            // If any field is filled, validate the complete time
            if (!hour || !ampm) {
                showError('timeError', 'Please complete the time or click "Unknown Time"');
                showValidation('timeValidation', false);
                return false;
            }
            
            const min = parseInt(minute) || 0;
            if (min < 0 || min > 59) {
                showError('timeError', 'Minutes must be between 0 and 59');
                showValidation('timeValidation', false);
                return false;
            }
            
            hideError('timeError');
            showValidation('timeValidation', true);
            return true;
        }

        function validateForm() {
            const dateValid = validateDate();
            const timeValid = validateTime(); // Time is now optional
            const placeValid = document.getElementById('latitude').value && 
                               document.getElementById('longitude').value;
            
            if (!placeValid) {
                showError('placeError', 'Please select a location from the dropdown');
                showValidation('placeValidation', false);
            } else {
                hideError('placeError');
                showValidation('placeValidation', true);
            }
            
            return dateValid && timeValid && placeValid;
        }

        // Soul Age Calculation
        function calculateSoulAge() {
            if (AppState.isCalculating) return;
            
            AppState.isCalculating = true;
            
            // Collect form data
            const birthDate = new Date(document.getElementById('birthDate').value);
            let hour = parseInt(document.getElementById('birthHour').value);
            let minute = parseInt(document.getElementById('birthMinute').value) || 0;
            let ampm = document.getElementById('ampm').value;
            const lat = parseFloat(document.getElementById('latitude').value);
            const lng = parseFloat(document.getElementById('longitude').value);
            
            // Handle unknown time - default to noon (12:00 PM)
            let timeKnown = true;
            if (!hour || !ampm) {
                hour = 12;
                minute = 0;
                ampm = 'PM';
                timeKnown = false;
                AppState.timeEstimated = true;
            }
            
            // Store in app state
            AppState.birthData = {
                date: birthDate,
                hour: hour,
                minute: minute,
                ampm: ampm,
                latitude: lat,
                longitude: lng,
                timeKnown: timeKnown
            };
            
            // Show loading
            document.getElementById('loading').classList.add('show');
            document.getElementById('calculateBtn').disabled = true;
            
            // Simulate calculation
            setTimeout(() => {
                const results = performCalculation();
                AppState.calculationResults = results;
                displayResults(results);
                
                document.getElementById('loading').classList.remove('show');
                document.getElementById('calculateBtn').disabled = false;
                AppState.isCalculating = false;
            }, 2500);
        }

        function performCalculation() {
            const { date, hour, minute, ampm, latitude, longitude, timeKnown } = AppState.birthData;
            
            // Convert to 24-hour
            let hour24 = hour;
            if (ampm === 'PM' && hour !== 12) hour24 += 12;
            if (ampm === 'AM' && hour === 12) hour24 = 0;
            
            // Vedantic calculation based on birth chart
            const dayOfYear = getDayOfYear(date);
            const timeScore = (hour24 * 60 + minute) / 1440;
            const latitudeModifier = Math.abs(latitude) / 90;
            
            // Base calculation
            let baseAge = 200 + (dayOfYear * 1.1) + (latitudeModifier * 50);
            
            // Adjust time weight based on whether it's known or estimated
            const timeWeight = timeKnown ? 0.3 : 0.1; // Reduce time influence if estimated
            baseAge += (timeScore * 150 * timeWeight);
            
            // Apply survey modifiers
            let surveyModifier = 0;
            spiritualQuestions.forEach((question, index) => {
                const answer = AppState.surveyAnswers[index];
                if (answer !== undefined) {
                    const normalizedAnswer = (answer / 4) - 0.5; // -0.5 to 0.5
                    surveyModifier += normalizedAnswer * 100 * question.weight;
                }
            });
            
            let soulAge = Math.round(baseAge + surveyModifier);
            
            // Ensure within bounds
            soulAge = Math.max(1, Math.min(777, soulAge));
            
            return {
                soulAge: soulAge,
                stage: getSoulStage(soulAge),
                incarnationRange: getIncarnationRange(soulAge),
                earthYears: Math.round(soulAge * 165), // Average 165 years between incarnations
                spiralLevel: getSpiralLevel(soulAge),
                remainingLives: Math.max(0, 777 - soulAge),
                timeEstimated: !timeKnown
            };
        }

        function displayResults(results) {
            const container = document.getElementById('resultsContainer');
            
            // Show time estimation notice if applicable
            const timeNotice = document.getElementById('timeEstimatedNotice');
            if (results.timeEstimated) {
                timeNotice.style.display = 'block';
            } else {
                timeNotice.style.display = 'none';
            }
            
            document.getElementById('soulAgeNumber').textContent = `~${results.soulAge}`;
            document.getElementById('soulStage').textContent = results.stage;
            document.getElementById('incarnationRange').textContent = results.incarnationRange;
            document.getElementById('earthYears').textContent = `~${Math.round(results.earthYears / 1000)}k`;
            document.getElementById('spiralLevel').textContent = `${results.spiralLevel}`;
            document.getElementById('remainingLives').textContent = results.remainingLives;
            
            container.classList.add('show');
            container.scrollIntoView({ behavior: 'smooth' });
            
            // Generate spiritual guidance
            generateGuidance(results);
        }

        function generateGuidance(results) {
            const guidanceContent = document.getElementById('guidanceContent');
            const guidance = getGuidanceForSoulAge(results.soulAge, results.stage);
            
            guidanceContent.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px; font-size: 1.5rem;">Your Spiritual Path: ${results.stage}</h3>
                    <p style="line-height: 1.7; opacity: 0.95;">${guidance.description}</p>
                </div>
                
                <div class="stage-grid">
                    <div class="stage-card">
                        <div class="stage-title">🎯 Current Lessons</div>
                        <div class="stage-description">${guidance.lessons}</div>
                    </div>
                    <div class="stage-card">
                        <div class="stage-title">⚡ Spiritual Practices</div>
                        <div class="stage-description">${guidance.practices}</div>
                    </div>
                    <div class="stage-card">
                        <div class="stage-title">🌟 Soul Mission</div>
                        <div class="stage-description">${guidance.mission}</div>
                    </div>
                </div>
            `;
            
            guidanceContent.style.display = 'block';
        }

        // Helper Functions
        function getDayOfYear(date) {
            const start = new Date(date.getFullYear(), 0, 0);
            const diff = date - start;
            const oneDay = 1000 * 60 * 60 * 24;
            return Math.floor(diff / oneDay);
        }

        function getSoulStage(age) {
            if (age <= 35) return "Infant Soul - Learning Survival";
            if (age <= 105) return "Baby Soul - Seeking Structure";
            if (age <= 210) return "Young Soul - Building Achievement";
            if (age <= 350) return "Mature Soul - Heart Chakra Activation";
            if (age <= 490) return "Old Soul - Wisdom Integration";
            if (age <= 700) return "7th Level Soul - Transcendence Preparation";
            return "Advanced Soul - Liberation Approach";
        }

        function getIncarnationRange(age) {
            const margin = 15;
            return `${Math.max(1, age - margin)}-${Math.min(777, age + margin)}`;
        }

        function getSpiralLevel(age) {
            return Math.ceil(age / 111);
        }

        function getGuidanceForSoulAge(age, stage) {
            if (age <= 105) {
                return {
                    description: "You are in the foundational stages of soul development, focused on learning basic survival and civilizational skills.",
                    lessons: "Master physical plane basics, develop moral compass, learn from established structures and authorities.",
                    practices: "Structured meditation, traditional spiritual practices, community involvement, following established wisdom traditions.",
                    mission: "Build a strong foundation for future growth while serving your community through practical means."
                };
            } else if (age <= 210) {
                return {
                    description: "You are in an ambitious phase, focused on achievement, success, and making your mark on the world.",
                    lessons: "Balance ambition with compassion, learn leadership skills, understand power dynamics and responsibility.",
                    practices: "Goal-setting meditation, visualization, networking for positive change, competitive sports or business ventures.",
                    mission: "Build civilizations, create innovations, and lead others while learning ethical use of power."
                };
            } else if (age <= 350) {
                return {
                    description: "You are entering emotional and relational mastery, seeking deeper meaning and authentic connections.",
                    lessons: "Develop emotional intelligence, practice unconditional love, heal relationship patterns, embrace vulnerability.",
                    practices: "Heart-centered meditation, therapy or counseling, creative expression, intimate relationship work.",
                    mission: "Heal collective emotional wounds, teach empathy and compassion, bridge different perspectives."
                };
            } else if (age <= 490) {
                return {
                    description: "You are in the wisdom integration phase, naturally drawn to teaching, philosophy, and spiritual service.",
                    lessons: "Detach from drama, integrate all life experiences into wisdom, develop universal perspective.",
                    practices: "Contemplative meditation, teaching or mentoring, philosophical study, service to humanity.",
                    mission: "Share wisdom through teaching, writing, or counseling; guide younger souls on their journey."
                };
            } else {
                return {
                    description: "You are in advanced stages of soul evolution, preparing for final lessons before liberation from the physical plane.",
                    lessons: "Complete integration of all soul experiences, prepare for transcendence, serve as a bridge between realms.",
                    practices: "Advanced meditation techniques, energy healing, channeling or mediumship, global service projects.",
                    mission: "Serve as a spiritual teacher or guide for humanity, facilitate planetary healing and consciousness evolution."
                };
            }
        }

        // Error Display Functions
        function showError(id, message) {
            const errorEl = document.getElementById(id);
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.add('show');
            }
        }

        function hideError(id) {
            const errorEl = document.getElementById(id);
            if (errorEl) {
                errorEl.classList.remove('show');
            }
        }

        function showValidation(id, isValid) {
            const indicator = document.getElementById(id);
            if (indicator) {
                indicator.className = `validation-indicator ${isValid ? 'valid' : 'invalid'}`;
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
